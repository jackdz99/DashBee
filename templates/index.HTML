<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Meteo</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-light">
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary p-3 shadow">
        <div class="container">
            <a class="navbar-brand" href="#">Dashboard</a>
            <div>
                <button class="btn btn-light me-2" onclick="showSection('homepage')">Homepage</button>
                <button class="btn btn-light me-2" onclick="showSection('azienda')">Azienda</button>
                <button class="btn btn-light" onclick="showSection('alveari')">Alveari</button>
            </div>
        </div>
    </nav>
    
    <div class="container mt-4">
        <div id="homepage" class="bg-white p-4 rounded shadow">
            <h2 class="h4 mb-4">Homepage</h2>
            <div class="row">
                <div class="col-md-6 mb-4">
                    <div class="card p-3">
                        <h5 class="card-title">Previsioni prossimi 7 giorni</h5>
                        <div id="forecast"></div>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card p-3">
                        <h5 class="card-title">Temperatura ultimo mese</h5>
                        <canvas id="temperatureChart"></canvas>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card p-3">
                        <h5 class="card-title">Temperature Medie</h5>
                        <p id="averageTemperatures"></p>
                    </div>
                </div>
                <div class="col-md-6 mb-4">
                    <div class="card p-3">
                        <h5 class="card-title">Stagione Attuale</h5>
                        <p id="currentSeason"></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        function showSection(section) {
            document.getElementById('homepage').classList.toggle('d-none', section !== 'homepage');
        }

        async function fetchWeatherData() {
            const response = await fetch('/api/weather');
            const data = await response.json();
            
            let labels = data.dates;
            let tempMax = data.temp_max;
            let tempMin = data.temp_min;
            
            new Chart(document.getElementById('temperatureChart').getContext('2d'), {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: 'Temp Max (°C)', data: tempMax, borderColor: 'red', fill: false },
                        { label: 'Temp Min (°C)', data: tempMin, borderColor: 'blue', fill: false }
                    ]
                }
            });
            
            document.getElementById('averageTemperatures').innerText = `Temperatura media del mese: ${data.average_temp}°C`;
        }

        async function fetchSeason() {
            const response = await fetch('/api/season');
            const data = await response.json();
            document.getElementById('currentSeason').innerText = `Stagione attuale: ${data.season}`;
        }

        fetchWeatherData();
        fetchSeason();

        async function updateTemperatureChart() {
        try {
            const response = await fetch('/api/weather');  // Recupera i dati dall'API Flask
            const data = await response.json();

            if (!data.daily || !data.daily.time || !data.daily.temperature_2m_max || !data.daily.temperature_2m_min) {
                console.error("Dati meteo non validi:", data);
                return;
            }

            const labels = data.daily.time.map(date => new Date(date).toLocaleDateString("it-IT"));
            const tempMax = data.daily.temperature_2m_max;
            const tempMin = data.daily.temperature_2m_min;

            const ctx = document.getElementById('temperatureChart').getContext('2d');

            // Se esiste già un grafico, lo distruggiamo per evitarne la sovrapposizione
            if (window.myTemperatureChart) {
                window.myTemperatureChart.destroy();
            }

            window.myTemperatureChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Temp Max (°C)',
                            data: tempMax,
                            borderColor: 'red',
                            backgroundColor: 'rgba(255, 0, 0, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        },
                        {
                            label: 'Temp Min (°C)',
                            data: tempMin,
                            borderColor: 'blue',
                            backgroundColor: 'rgba(0, 0, 255, 0.2)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            title: { display: true, text: "Data" }
                        },
                        y: {
                            title: { display: true, text: "Temperatura (°C)" }
                        }
                    }
                }
            });
        } catch (error) {
            console.error("Errore nel recupero dei dati meteo:", error);
        }
    }

    updateTemperatureChart();

    </script>
</body>
</html>
